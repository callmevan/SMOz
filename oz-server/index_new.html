<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI of Oz</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background-color: #f8fafc; /* 更清爽的背景色 */
        }
        body {
            display: flex;
            height: 100vh;
        }
        .avatar-summary-section, .operation-section, .chat-dialogue-section {
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 16px; /* 增加圆角 */
            margin: 12px; /* 调整间距 */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06); /* 更精致的阴影 */
            transition: all 0.3s ease;
        }
        .avatar-summary-section {
            width: 35%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .avatar-container {
            width: 100%;
            height: 45%;
            background-color: #f9fafb;
            border: 1px solid rgba(100, 149, 237, 0.2); /* 更细腻的边框 */
            border-radius: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .summary-container-wrapper {
            width: 100%;
            height: 50%;
            background-color: #f9fafb;
            border-radius: 14px;
            padding: 18px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .operation-section {
            width: 25%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background-color: #ffffff;
        }
        
        .response-container {
            background-color: #f9fafb;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            height: 45%;
        }

        .chat-dialogue-section {
            width: 40%;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
        }
        
        .chat-history-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f9fafb;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }
        
        #user-input-wrapper {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }
        
        .avatar-container video {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        
        h3 {
            font-size: 28px;
            font-weight: 600;
            color: #3b5998;
            margin: 18px 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            letter-spacing: 0.5px;
        }

        #user-input {
            width: 100%;
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
            font-size: 20px;
            line-height: 1.6;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        #chat-history p {
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
            line-height: 1.6;
            font-size: 20px;
        }

        .form-check-label {
            font-size: 18px;
            color: #3b5998;
            font-weight: 500;
            cursor: pointer;
        }

        .button-container button {
            margin: 6px;
            height: 50px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-size: 20px;
            font-weight: 500;
            padding: 0 26px;
            border: none;
            cursor: pointer;
            width: 170px;
            transition: all 0.3s ease;
        }

        #model2-response, #model3-response, #default-response {
            font-size: 20px;
            line-height: 1.6;
            padding: 16px;
        }
        .form-check-label {
            font-size: 15px; // 增大模式选择器标签字体
            color: #3b5998;
            font-weight: 500;
            cursor: pointer;
        }

        .button-container button {
            margin: 5px;
            height: 42px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-size: 16px; // 增大按钮字体
            font-weight: 500;
            padding: 0 20px;
            border: none;
            cursor: pointer;
            width: 150px;
            transition: all 0.3s ease;
        }
        .button-container {
            margin-top: auto;
            display: flex;
            justify-content: center;
            padding: 12px 0;
        }
        .button-container button {
            margin: 5px;
            height: 42px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-size: 15px;
            font-weight: 500;
            padding: 0 20px;
            border: none;
            cursor: pointer;
            width: 150px;
            transition: all 0.3s ease;
        }
        .btn-success {
            background-color: #4a7aff;
            color: white;
        }

        .btn-success:hover {
            background-color: #3a67e8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #90b4e0;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7aa3d5;
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: #7d91b8;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-info {
            background-color: #8fb8f8;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover, .btn-info:hover {
            background-color: #d8e1f3;
            color: #3b5998;
            transform: translateY(-2px);
        }

        .active-primary {
            background-color: #1a3a8a;
        }

        .active-primary:hover {
            background-color: #0e2a6a;
        }

        .active-info {
            background-color: #4a90e2;
        }

        .active-info:hover {
            background-color: #3a7ac8;
        }

        #user-input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }
        
        #user-input:focus {
            border-color: #4a7aff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 122, 255, 0.1);
        }
        
        #chat-history p {
            padding: 12px;
            border-radius: 10px;
            margin: 8px 0;
            line-height: 1.5;
            font-size: 15px;
        }
        
        /* 美化滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1d3f0;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a7aff;
        }

        /* 模式选择器样式 */
        .mode-selector {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 18px;
            background-color: #f9fafb;
            padding: 12px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .mode-selector .form-check {
            margin-left: 18px;
            display: flex;
            align-items: center;
        }
        
        .form-check-input {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .form-check-label {
            font-size: 14px;
            color: #3b5998;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* 添加响应式设计 */
        @media (max-width: 1200px) {
            body {
                flex-direction: column;
                overflow-y: auto;
            }
            .avatar-summary-section, .operation-section, .chat-dialogue-section {
                width: 95%;
                margin: 10px auto;
            }
        }
    </style>
</head>
<body>
    <!-- Avatar Video and Summary -->
    <div class="avatar-summary-section">
        <div class="avatar-container">
            <video id="avtar-video" autoplay></video>
        </div>
        <div class="summary-container-wrapper">
            <h3>Conversation Summary</h3>
            <div id="summary-container">
                <p id="model3-response"></p>
            </div>
        </div>
    </div>

    <!-- Operation Section -->
    <div class="operation-section">
        <div class="mode-selector">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="responseMode" id="autoMode" value="auto">
                <label class="form-check-label" for="autoMode">Auto Mode</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="responseMode" id="semiMediatorMode" value="semi">
                <label class="form-check-label" for="semiMediatorMode">Semi Mediator</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="responseMode" id="mediatorMode" value="mediator" checked>
                <label class="form-check-label" for="mediatorMode">Mediator Mode</label>
            </div>
        </div>
        <div class="response-container" id="default-response-wrapper">
            <h3>Default Response:</h3>
            <div style="flex-grow: 1; overflow-y: auto;">
                <p id="default-response">I'm not able to respond to that, but I'm here if you want to talk about other topics.</p>
            </div>
            <div class="button-container">
                <button id="send-default-btn" type="button" class="btn btn-secondary">Apply</button>
            </div>
        </div>
        <div class="response-container" id="proposed-response-wrapper">
            <h3>Generated Response:</h3>
            <div id="model2-response" style="flex-grow: 1; overflow-y: auto;"></div>
            <div class="button-container">
                <button id="approve-btn" type="button" class="btn btn-success">Approve</button>
            </div>
        </div>
    </div>

    <!-- Chat History and Dialogue -->
    <div class="chat-dialogue-section">
        <div class="chat-history-container">
            <h3>Chat History</h3>
            <div id="chat-history"></div>
        </div>
        <div id="user-input-wrapper">
            <textarea id="user-input" placeholder="Type your message here..." rows="4"></textarea>
            <div class="button-container">
                <button id="submit-btn" type="button" class="btn btn-primary">Submit</button>
                <button id="refine-btn" type="button" class="btn btn-info">Refine with AI</button>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
let chatHistory = [];
let ifExplain = false;
let currentSensitivity = '';
// 添加新变量用于跟踪完整对话记录
let conversationLog = [];

function addMessageToChat(sender, message, sensitivity = '') {
    const timestamp = new Date().toLocaleTimeString();
    chatHistory.push({ sender, message, timestamp, sensitivity });
    updateChatDisplay();
}

function updateChatDisplay() {
    const chatHistoryElement = document.getElementById('chat-history');
    chatHistoryElement.innerHTML = ''; // 清空当前聊天历史显示
    chatHistory.forEach(msg => {
        const messageElement = document.createElement('p');
        messageElement.textContent = `[${msg.timestamp}] ${msg.sender.toUpperCase()}: ${msg.message}`;
        messageElement.style.flex = '1'; // 确保消息可以伸展填满除按钮外的空间

        // 根据敏感度设置消息颜色
        if (msg.sender.toLowerCase() === 'user') {
            let sensitivityLabel = '';

            switch (msg.sensitivity.toLowerCase()) {
                case 'green':
                    messageElement.style.color = '#2E8B57'; // 深绿色
                    messageElement.style.backgroundColor = '#E8F5E9'; // 浅绿色背景
                    sensitivityLabel = ' [Sensitivity: Low]';
                    break;
                case 'yellow':
                    messageElement.style.color = '#B7950B'; // 深黄色
                    messageElement.style.backgroundColor = '#FFF9C4'; // 浅黄色背景
                    sensitivityLabel = ' [Sensitivity: Medium]';
                    break;
                case 'red':
                    messageElement.style.color = '#B71C1C'; // 深红色
                    messageElement.style.backgroundColor = '#FFEBEE'; // 浅红色背景
                    sensitivityLabel = ' [Sensitivity: High]';
                    break;
                default:
                    messageElement.style.color = '#333333';
                    messageElement.style.backgroundColor = '#F5F5F5'; // 浅灰色背景
            }
            messageElement.textContent += sensitivityLabel;
        } else {
            // Digital Human 消息样式
            messageElement.style.color = '#1565C0'; // 蓝色
            messageElement.style.backgroundColor = '#E3F2FD'; // 浅蓝色背景
        }

        // 创建包裹消息和按钮的容器
        const messageContainer = document.createElement('div');
        messageContainer.style.display = 'flex';
        messageContainer.style.justifyContent = 'space-between';
        messageContainer.style.alignItems = 'center';
        messageContainer.style.marginBottom = '10px';

        messageContainer.appendChild(messageElement);

        if (msg.sender.toLowerCase() === 'user' && ifExplain) {
            const explanationButton = document.createElement('button');
            explanationButton.textContent = 'Explanation';
            explanationButton.style.marginLeft = '10px';
            explanationButton.style.padding = '5px 10px';
            explanationButton.style.borderRadius = '5px';
            explanationButton.style.border = 'none';
            explanationButton.style.backgroundColor = '#A8C9FA';
            explanationButton.style.color = 'white';
            explanationButton.style.cursor = 'pointer';

            explanationButton.onclick = function() {
                alert(msg.explanation || 'No explanation provided.');
            };

            messageContainer.appendChild(explanationButton);
        }

        chatHistoryElement.appendChild(messageContainer);
    });
}

// 获取当前选择的模式
function getCurrentMode() {
    if (document.getElementById('autoMode').checked) {
        return 'auto';
    } else if (document.getElementById('semiMediatorMode').checked) {
        return 'semi';
    } else {
        return 'mediator';
    }
}

var ws = new WebSocket("wss://oz-server.app.localhost/ws");
// 修改 ws.onmessage 函数，记录AI生成的回复
ws.onmessage = function(event) {
    if (!event.data) {
        return;
    }
    const data = JSON.parse(event.data);
    const { kind, human_message, ai_proposed_message, sensitivity } = data;

    if (kind === 'summary') {
        const summaryRes = document.getElementById('model3-response');
        const { summary } = data;
        summaryRes.textContent = summary;
        return;
    } else if (kind === 'refined') {
        const { message } = data;
        document.getElementById('user-input').value = message;
        // 移除了 alert 提示
        return;
    } else {
        addMessageToChat('user', human_message, sensitivity);
        currentSensitivity = sensitivity.toLowerCase();

        // 记录用户输入到完整对话记录
        conversationLog.push({
            type: 'user_input',
            message: human_message,
            timestamp: new Date().toLocaleString(),
            sensitivity: sensitivity
        });

        // 记录AI生成的回复到完整对话记录
        conversationLog.push({
            type: 'ai_generated',
            message: ai_proposed_message,
            timestamp: new Date().toLocaleString()
        });

        // Set AI proposed response
        const proposedRes = document.getElementById('model2-response');
        proposedRes.textContent = ai_proposed_message;
        
        // 根据当前模式和敏感度决定是否自动提交
        const currentMode = getCurrentMode();
        
        if (currentMode === 'auto') {
            // 自动模式：直接提交AI回复
            autoSubmitResponse(ai_proposed_message);
        } else if (currentMode === 'semi' && currentSensitivity === 'green') {
            // 半自动模式且敏感度为绿色：直接提交AI回复
            autoSubmitResponse(ai_proposed_message);
        }
        // 其他情况（mediator模式或semi模式下的黄色/红色敏感度）：等待用户手动确认
    }
};

// 修改 submit-btn 点击事件，记录最终提交的回复
document.getElementById('submit-btn').addEventListener('click', async () => {
    const userInput = document.getElementById('user-input').value;
    if (ws.readyState === WebSocket.OPEN && userInput) {
        ws.send(JSON.stringify({kind: "message", message: userInput, intervene: false}));
        addMessageToChat('Digital Human', userInput);
        
        // 记录最终提交的回复到完整对话记录
        conversationLog.push({
            type: 'submitted_response',
            message: userInput,
            timestamp: new Date().toLocaleString()
        });
        
        document.getElementById('user-input').value = ''; // 清空输入栏
        document.getElementById('model2-response').innerText = ''; // 清空Proposed Response内容
        updateButtonStyles(); // 更新按钮样式
    }
});

// 添加页面关闭事件，自动下载对话记录
window.addEventListener('beforeunload', function(e) {
    // 创建对话记录文本
    let logText = "Conversation Log - " + new Date().toLocaleString() + "\n\n";
    
    // 按时间顺序组织对话
    conversationLog.forEach((entry, index) => {
        switch(entry.type) {
            case 'user_input':
                logText += `[${entry.timestamp}] User: ${entry.message}\n`;
                if (entry.sensitivity) {
                    logText += `Sensitivity: ${entry.sensitivity}\n`;
                }
                logText += "\n";
                break;
            case 'ai_generated':
                logText += `[${entry.timestamp}] AI Generated Response: ${entry.message}\n\n`;
                break;
            case 'submitted_response':
                logText += `[${entry.timestamp}] Submitted Response: ${entry.message}\n\n`;
                break;
        }
    });
    
    // 创建下载链接
    const blob = new Blob([logText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Conversation_Log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // 为了确保下载开始，添加一个小延迟
    e.preventDefault();
    e.returnValue = '';
    
    setTimeout(function() {
        window.close();
    }, 1000);
});

// 自动提交响应的函数
function autoSubmitResponse(message) {
    document.getElementById('user-input').value = message;
    document.getElementById('model2-response').innerText = '';
    setTimeout(() => {
        document.getElementById('submit-btn').click();
    }, 500);
}

// 当用户在输入框中输入内容时，触发颜色变化
document.getElementById('user-input').addEventListener('input', function() {
    updateButtonStyles();
});

// 当点击 "Approve Proposed Response" 按钮时，设置输入框内容并更新按钮样式
document.getElementById('approve-btn').addEventListener('click', function() {
    const approvedMessage = document.getElementById('model2-response').innerText;
    document.getElementById('user-input').value = approvedMessage;
    document.getElementById('model2-response').innerText = '';
    updateButtonStyles(); // 手动调用函数更新按钮样式
});

// 当点击 "Send Default" 按钮时，设置输入框内容并更新按钮样式
document.getElementById('send-default-btn').addEventListener('click', function() {
    const defaultMessage = document.getElementById('default-response').innerText;
    document.getElementById('user-input').value = defaultMessage;
    updateButtonStyles(); // 手动调用函数更新按钮样式
});

// 更新按钮样式的函数
function updateButtonStyles() {
    const userInput = document.getElementById('user-input').value;
    const submitButton = document.getElementById('submit-btn');
    const refineButton = document.getElementById('refine-btn');

    if (userInput.trim() !== '') {
        submitButton.classList.add('active-primary');
        refineButton.classList.add('active-info');
    } else {
        submitButton.classList.remove('active-primary');
        refineButton.classList.remove('active-info');
    }
}

document.getElementById('refine-btn').addEventListener('click', () => {
    const userInput = document.getElementById('user-input').value;
    if (ws.readyState === WebSocket.OPEN && userInput) {
        ws.send(JSON.stringify({kind: "refine", message: userInput, intervene: false}));
    }
});

// Handle the "Submit" button click event
document.getElementById('submit-btn').addEventListener('click', async () => {
    const userInput = document.getElementById('user-input').value;
    if (ws.readyState === WebSocket.OPEN && userInput) {
        ws.send(JSON.stringify({kind: "message", message: userInput, intervene: false}));
        addMessageToChat('Digital Human', userInput);
        document.getElementById('user-input').value = ''; // 清空输入栏
        document.getElementById('model2-response').innerText = ''; // 清空Proposed Response内容
        updateButtonStyles(); // 更新按钮样式
    }
});

// 屏幕共享代码，用于Avatar视频显示
if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
    navigator.mediaDevices.getDisplayMedia({ video: true })
        .then(stream => {
            const videoElement = document.getElementById('avtar-video');
            videoElement.srcObject = stream;
        })
        .catch(err => {
            console.error("Error capturing screen:", err);
        });
} else {
    console.log("Screen capture is not supported in this browser.");
}
</script>

</body>
</html>